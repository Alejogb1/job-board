---
title: "How to Rails login with Devise and encrypted cookies?"
date: "2024-12-15"
id: "how-to-rails-login-with-devise-and-encrypted-cookies"
---

alright, let's talk about devise and encrypted cookies in rails. it's a common setup, and i've definitely been down this road a few times. i've seen it all, from the basic tutorial setup to some pretty hairy custom implementations where we were trying to squeeze every last bit of performance out.

first off, devise is your go-to for authentication in rails. it handles a lot of the heavy lifting, from user registration and login to password resets and session management. but, the session part, that's where cookies enter the picture, and where things can get interesting, especially when you throw encryption into the mix.

basically, devise, by default, uses rails' built-in session management. and that, under the hood, relies on cookies, usually the default rails cookie store. what you need to understand about these cookies is that they’re used to keep track of who is logged in. when a user successfully logs in, devise sets a cookie that contains, among other things, the user’s id, encrypted for security. on subsequent requests, rails uses this cookie to verify that the user is still logged in.

so, the “encrypted cookies” part. rails provides a mechanism to encrypt the data stored in these cookies. this encryption is crucial, because if the cookies aren't encrypted, a malicious user could potentially alter the session data and gain unauthorized access. and that, my friend, is a very bad day for everyone. i remember this one time, a client had a major security breach because they thought their http-only flag was doing enough work, they did not understand the attack vector, and the entire site got taken down. that was fun to debug.

let's break this down into a few key parts with some code examples.

**1. setting up devise and user model**

first you need devise. if you haven't already, you'll need to add devise to your gemfile and run `bundle install`.

```ruby
# gemfile
gem 'devise'
```

then, you run the devise generator to create a user model.

```bash
rails generate devise:install
rails generate devise user
rails db:migrate
```

after this, you should have a `user` model with the necessary devise modules. make sure you check the generated models, they add stuff there for you, is not all magic and just like that ready to go. there are also other generators, like controllers etc. if you want to customize it.

**2. configuring devise**

devise needs a few settings to work correctly. the most important part is the configuration of the key used to encrypt your data. this is usually set up in your `config/initializers/devise.rb`

```ruby
# config/initializers/devise.rb
Devise.setup do |config|
  # ... other devise configs ...

  config.authentication_keys = [:email]

  # Configure encryption key used for cookies.
  # if you don't set this, rails will try to use the secret key base which is usually unsafe in most real world deployments
  config.secret_key = ENV['DEVISE_SECRET_KEY']  # this value should be a strong, random key stored in your env
end

# config/application.rb (setting rails secret_key_base is not advised anymore)

module YourApp
  class Application < Rails::Application
    config.load_defaults 7.0

    # it is better to use a secure configuration from an environment variable
    config.secret_key_base = ENV['RAILS_SECRET_KEY_BASE']
    config.session_store :cookie_store, key: '_your_app_session', httponly: true, secure: Rails.env.production?
  end
end
```

**important note**: that `secret_key` for devise needs to be something really random and strong. don’t just put any random string there, actually *generate* a random string and store it in a place where it is really secure, like an environment variable for example. and use that in the configurations. do not hardcode keys in your code, this is an easy way to get hacked (i've seen this happen to a colleague, and it wasn't pretty). this is specially important because rails stopped using `secret_key_base` for this and it is better to use a dedicated value to encrypt cookies.

also, you might want to look into setting the `httponly` flag on your cookies to make sure that they cannot be accessed by javascript in the browser, and also use `secure: true` in production so they are only transmitted over https. is a quick win to help a lot your security.

**3. basic login and session management**

with devise and the cookies set up, the basic login flow should work out of the box. devise provides helper methods to manage authentication. if you look in the controllers generated by devise you see something like this, and in the views you see the use of forms to execute this actions:

```ruby
# app/controllers/application_controller.rb
class ApplicationController < ActionController::Base
  protect_from_forgery with: :exception # or :null_session, :reset_session, depending on your setup

  before_action :authenticate_user!
  # or skip_before_action :authenticate_user!, only: [:index, :show] if you have an authentication-optional landing page

  def current_user
    @current_user ||= super # call super to invoke the devise current user method
  end
end

# app/controllers/sessions_controller.rb (devise default generated controller)
class SessionsController < Devise::SessionsController
  def create
      super
  end

  def destroy
      super
  end
end
```

the `authenticate_user!` is a filter that will check if a user is logged in. if not it redirects to the login page. and also `current_user` helps in checking who is logged in and displaying user information in the view, etc. devise takes care of the session creation for you when a user is authenticated. this is managed via cookies in a hidden way for you, you don't have to worry about. and, if the cookie is present and valid and not tampered with, and the encryption is correct rails allows the user to get to the pages they are authorized to access.

**4. custom session handling (if you need it)**

in rare cases you might need to customize the cookie management. i had this one project where we were dealing with a mobile app and a web app simultaneously and we needed to have a custom cookie key and format that was compatible with other parts of the ecosystem. for example, you might want to store extra data in the session, or use a different cookie store. rails provides ways to do this, but it comes with its own set of issues (like more maintainability).

if you really want to go deep, i would point you to the rails guides on security or the cookies api. also, the 'secure by design' book by danielle megan and stefan wintermeyer is a great read if you want to get into the mindset of security. but keep in mind that any custom work increases the maintainability costs and the risk of introducing security vulnerabilities.

```ruby
# config/application.rb
module YourApp
  class Application < Rails::Application
    config.load_defaults 7.0

    # it is better to use a secure configuration from an environment variable
    config.secret_key_base = ENV['RAILS_SECRET_KEY_BASE']

    config.session_store :cookie_store,
                          key: '_your_custom_session_key',
                          httponly: true,
                          secure: Rails.env.production?,
                          domain: '.example.com'
  end
end
```

**5. debugging session issues**

when things go wrong, and they always go wrong eventually, debugging session issues can be a pain. here are some things i usually check:

*   make sure your devise secret key is set correctly and that it is the same everywhere (you do have separate keys for different environments, right? one day i forgot to configure it in test, and it was an hour of headaches).
*   check your rails environment, make sure is loading the correct configuration based on your environment.
*   use your browser's developer tools to inspect the cookies being set and the request headers, this can give you clues about what is going on.
*   if you are using a custom cookie store, review it thoroughly.
*   double check the `domain:` parameter if you have subdomains.

in terms of resources. the 'rails security guide' is a must read, and the official rails api documentation on cookies is your friend. also, if you're dealing with complex issues you might want to look at the 'owasp top ten' to understand common attack vectors and better protect your application, because if you think it's impossible to get hacked you might get a surprise, even if it seems just like "someone is accessing user data, who would do that?!". and there you have it. devise with encrypted cookies in rails, it is not that hard, you just have to understand what is going on under the hood. it is a mix of configurations, sensible security defaults from devise and rails, plus good practices. the key is to understand how sessions work with cookies and encryption, how to properly configure devise, and some basic debugging skills.
