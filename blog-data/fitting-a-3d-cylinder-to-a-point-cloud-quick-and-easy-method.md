---
title: "Fitting a 3D Cylinder to a Point Cloud: Quick and Easy Method?"
date: '2024-11-08'
id: 'fitting-a-3d-cylinder-to-a-point-cloud-quick-and-easy-method'
---

```python
from scipy.optimize import minimize
from sklearn.preprocessing import StandardScaler
import pandas as pd
import matplotlib.pyplot as plt
from mpl_toolkits.mplot3d import Axes3D
from sklearn.model_selection import train_test_split
import numpy as np

# Define the cylinder equation
def cylinder_equation(params, xyz):
    a, b, c, r, nx, ny, nz = params
    x, y, z = xyz
    return ((x - a)**2 + (y - b)**2 - r**2) * (nx*(x - a) + ny*(y - b) + nz*(z - c))**2

def cost_function(params, xyz_data):
    total_error = 0
    for x, y, z in xyz_data:
        error = cylinder_equation(params, (x, y, z))
        total_error += error
    return total_error

# Plot 3D points
def plot_3d_points(vertices, xyz_test, a, b, c, r, nx, ny, nz):
    fig = plt.figure(figsize=(12, 6))
    ax1 = fig.add_subplot(121, projection='3d')  # For the 3D points
    ax2 = fig.add_subplot(122, projection='3d')  # For the cylinder surface

    x, y, z = vertices['x'], vertices['y'], vertices['z']
    ax1.scatter(x, y, z, c='b', marker='o')
    xyz_test = scaler.inverse_transform(xyz_test)
    ax1.scatter(xyz_test[:, 0], xyz_test[:, 1], xyz_test[:, 2], c='r', marker='x')
    ax1.set_xlabel('X Label')
    ax1.set_ylabel('Y Label')
    ax1.set_zlabel('Z Label')

    resolution = 100
    theta = np.linspace(0, 2 * np.pi, resolution)
    z_surface = np.linspace(min(z), max(z), resolution)
    Z, Theta = np.meshgrid(z_surface, theta)
    X = a + r * np.cos(Theta)
    Y = b + r * np.sin(Theta)
    ax2.plot_surface(X, Y, Z, cmap='Greens', alpha=1)

    predicted_z = np.array([cylinder_equation([a, b, c, r, nx, ny, nz], xyz) for xyz in xyz_test])
    shift_z = predicted_z - xyz_test[:, 2]

    # Plot the points with the z-shift
    ax1.scatter(xyz_test[:, 0], xyz_test[:, 1], xyz_test[:, 2] + shift_z, c='black', marker='x')

    plt.show()


if __name__ == "__main__":
    # Load data
    points = pd.DataFrame({
        'x': [-0.19509, -0.707107, -0.83147, -0.92388, -0.92388, -0.980785, -0.980785, -1.0, -0.980785, -0.707107,
               -0.55557, -0.097545, -0.19509, -0.288887, -0.469127, -0.55557, -0.631338, -0.631338, -0.769288,
               -0.877675, -0.877675, -0.92388, -0.952332, -0.952332, -0.980785, -0.990393, -0.990393, -1.0,
               -0.990393, -0.990393, -0.980785, -0.877675, -0.877675, -0.83147, -0.769288, -0.631338, -0.55557,
               -0.469127, -0.952332, -0.990393, -0.952332, -0.877675, -0.631338, -0.097545, 0.097545, -0.048773,
               -0.19509, -0.335785, -0.425905, -0.55557, -0.669223, -0.593454, -0.738197, -0.83147, -0.900777,
               -0.854572, -0.92388, -0.966559, -0.938106, -0.980785, -0.985589, -0.985589, -0.938106, -0.966559,
               -0.900777, -0.83147, -0.593454, 0.0, -0.146318, -0.19509, -0.382683, -0.55557, -0.738197,
               -0.800379, -0.92388, -0.938106, -0.966559, -0.985589, -0.995196, -0.938106, -0.707107, -0.669223,
               -0.512349, -0.469127, -0.631338, -0.877675, -0.952332, -0.985589, -0.990393, -0.990393, -0.995196,
               -0.985589, -0.990393, -0.990393, -0.966559, -0.938106, -0.952332, -0.952332, -0.900777, -0.854572,
               -0.877675, -0.738197, -0.769288, -0.769288, -0.593454, -0.631338, -0.631338, -0.425905, -0.288887,
               -0.048773, -0.335785, -0.425905, -0.425905, -0.593454, -0.593454, -0.738197, -0.800379, -0.854572,
               -0.854572, -0.938106, -0.938106, -0.966559, -0.985589, -0.995196, -0.966559, -0.738197, -0.512349,
               -0.938106, -0.995196, -0.966559, -0.900777, -0.800379, -0.533959, -0.55557, -0.688165, -0.722652,
               -0.83147, -0.912328, -0.843021, -0.92388, -0.973672, -0.930993, -0.980785, -0.983187, -1.0,
               -0.997598, -0.973672, -0.92388, -0.912328, -0.722652, -0.574512, -0.55557, -0.121931, -0.19509,
               -0.265438, -0.447516, -0.490738, -0.753743, -0.784834, -0.83147, -0.889226, -0.92388, -0.945219,
               -0.959446, -0.987991, -0.959446, -0.866123, -0.650281, -0.55557, -0.490738, -0.574512, -0.631338,
               -0.631338, -0.769288, -0.769288, -0.952332, -0.992795, -0.990393, -0.997598, -0.987991, -0.973672,
               -0.945219, -0.952332, -0.952332, -0.912328, -0.866123, -0.877675, -0.877675, -0.815924, -0.769288,
               -0.688165, -0.631338, -0.533959, -0.359234, -0.265438, -0.288887, -0.097545, -0.073159, -0.265438,
               -0.382683, -0.490738, -0.784834, -0.753743, -0.83147, -0.866123, -0.92388, -0.959446, -0.945219,
               -0.980785, -0.992795, -0.987991, -0.987991, -0.992795, -0.889226, -0.784834, -0.612396, -0.447516,
               0.218539, -0.170704, -0.19509, -0.359234, -0.533959, -0.55557, -0.722652, -0.912328, -0.92388,
               -0.930993, -0.980785, -0.983187, -0.997598, -1.0, -0.983187, -0.973672, -0.930993, -0.83147,
               -0.688165, -0.688165, -0.877675, -0.952332, -0.987991, -0.990393, -0.992795, -0.983187, -0.990393,
               -0.990393, -0.959446, -0.930993, -0.952332, -0.952332, -0.877675, -0.784834, -0.722652, -0.769288,
               -0.631338, -0.631338, -0.490738, -0.312336, -0.218539, -0.121931, -0.097545, -0.048773, -0.048773,
               -0.048773, -0.170704, -0.265438, -0.218539, -0.241989, -0.359234, -0.335785, -0.447516, -0.425905,
               -0.425905, -0.447516, -0.425905, -0.425905, -0.533959, -0.490738, -0.593454, -0.593454, -0.612396,
               -0.593454, -0.593454, -0.688165, -0.650281, -0.753743, -0.722652, -0.738197, -0.722652, -0.738197,
               -0.738197, -0.784834, -0.800379, -0.800379, -0.866123, -0.843021, -0.854572, -0.854572, -0.866123,
               -0.854572, -0.854572, -0.889226, -0.900777, -0.900777, -0.945219, -0.930993, -0.938106, -0.938106,
               -0.945219, -0.930993, -0.938106, -0.938106, -0.973672, -0.959446, -0.966559, -0.966559, -0.987991,
               -0.985589, -0.987991, -0.983187, -0.985589, -0.992795, -0.995196, -0.995196, -0.995196, -0.992795,
               -0.995196, -0.985589, -0.985589, -0.973672, -0.966559, -0.966559, -0.889226, -0.912328, -0.900777,
               -0.815924, -0.738197, -0.669223, -0.669223, -0.593454, -0.593454, -0.490738, -0.593454, -0.930993,
               -0.945219, -0.938106, -0.983187, -0.985589, -0.997598, -0.992795, -0.995196, -0.995196, -0.973672,
               -0.959446, -0.966559, -0.966559, -0.900777, -0.900777, -0.815924, -0.784834, -0.800379, -0.688165,
               -0.650281, -0.533959, -0.490738, -0.359234, -0.170704, 0.024386, 0.048773, 0.048773, 0.073159,
               -0.121931, -0.121931, -0.170704, -0.312336, -0.359234, -0.490738, -0.490738, -0.533959, -0.650281,
               -0.688165, -0.784834, -0.784834, -0.815924, -0.889226, -0.889226, -0.959446, -0.959446, -0.973672,
               -0.992795, -0.992795, -0.997598, -0.987991, -0.987991, -0.945219, -0.930993, -0.753743, -0.574512,
               -0.533959, -0.574512, -0.650281, -0.688165, -0.784834, -0.889226, -0.912328, -0.973672, -0.973672,
               -0.997598, -0.997598, -0.997598, -0.992795, -0.992795, -0.992795, -0.983187, -0.987991, -0.983187,
               -0.987991, -0.959446, -0.959446, -0.973672, -0.930993, -0.930993, -0.945219, -0.930993, -0.930993,
               -0.945219, -0.889226, -0.889226, -0.912328, -0.843021, -0.843021, -0.843021, -0.843021, -0.784834,
               -0.784834, -0.722652, -0.722652, -0.753743, -0.722652, -0.722652, -0.753743, -0.650281, -0.650281,
               -0.688165, -0.490738, -0.490738, -0.533959, -0.218539, -0.218539, -0.218539, -0.265438, -0.121931,
               -0.170704, -0.265438, -0.265438, -0.359234, -0.447516, -0.447516, -0.533959, -0.688165, -0.753743,
               -0.753743, -0.866123, -0.866123, -0.945219, -0.945219, -0.973672, -0.987991, -0.997598, -0.992795,
               -0.959446, -0.574512, -0.843021, -0.983187, -0.997598, -0.973672, -0.912328, -0.815924, -0.688165,
               -0.533959, -0.170704, -0.206815, -0.697636, -0.823697, -0.83147, -0.918104, -0.92388, -0.927436,
               -0.980785, -0.981986, -0.998799, -0.918104, -0.565041, -0.19509, -0.479932, -0.55557, -0.64081,
               -0.761515, -0.871899, -0.88345, -0.92388, -0.948776, -0.955889, -0.980785, -0.989192, -0.991594,
               -1.0, -0.948776, -0.92388, -0.761515, -0.64081, -0.479932, -0.565041, -0.631338, -0.714879,
               -0.777061, -0.952332, -0.991594, -0.990393, -0.948776, -0.952332, -0.952332, -0.918104, -0.871899,
               -0.877675, -0.877675, -0.823697, -0.761515, -0.631338, -0.544765, -0.370959, -0.277162, -0.288887,
               -0.288887, -0.182897, -0.085352, -0.097545, 0.097545, -0.060966, -0.382683, -0.501543, -0.707107,
               -0.74597, -0.83147, -0.92388, -0.963002, -0.941663, -0.980785, -0.98679, -0.993995, -0.980785,
               -0.707107, -0.19509, -0.34751, -0.4151, -0.678694, -0.92388, -0.970115, -0.980785, -0.984388,
               -0.996397, -1.0, -0.980785, -0.848796, -0.808152, -0.678694, -0.769288, -0.877675, -0.952332,
               -0.98679, -0.993995, -0.984388, -0.990393, -0.990393, -0.963002, -0.934549, -0.952332, -0.952332,
               -0.895001, -0.877675, -0.792606, -0.769288, -0.583983, -0.631338, -0.631338, -0.4151, -0.230264,
               -0.288887, -0.048773, -0.277162, -0.230264, -0.335785, -0.4151, -0.425905, -0.425905, -0.4151,
               -0.544765, -0.583983, -0.593454, -0.593454, -0.583983, -0.593454, -0.593454, -0.761515, -0.761515,
               -0.738197, -0.823697, -0.792606, -0.800379, -0.800379, -0.871899, -0.848796, -0.854572, -0.854572,
               -0.871899, -0.854572, -0.854572, -0.895001, -0.900777, -0.900777, -0.948776, -0.934549, -0.938106,
               -0.938106, -0.948776, -0.934549, -0.938106, -0.938106, -0.963002, -0.966559, -0.966559, -0.984388,
               -0.985589, -0.989192, -0.995196, -0.996397, -0.985589, -0.970115, -0.966559, -0.966559, -0.906553,
               -0.900777, -0.88345, -0.900777, -0.854572, -0.800379, -0.738197, -0.64081, -0.593454, -0.512349,
               -0.981986, -0.995196, -0.977229, -0.963002, -0.966559, -0.966559, -0.918104, -0.900777, -0.900777,
               -0.792606, -0.659752, -0.544765, -0.501543, -0.512349, -0.182897, -0.134125, 0.048773, -0.230264,
               -0.382683, -0.4151, -0.678694, -0.583983, -0.83147, -0.92388, -0.970115, -0.934549, -0.984388,
               -0.970115, -0.808152, -0.583983, -0.55557, -0.19509, -0.55557, -0.792606, -0.83147, -0.92388,
               -0.941663, -0.963002, -0.980785, -0.98679, -0.707107, -0.501543, -0.952332, -0.990393, -0.990393,
               -0.941663, -0.952332, -0.877675, -0.877675, -0.769288, -0.631338, -0.631338, -0.436711, -0.34751,
               -0.288887, -0.288887, -0.085352, -0.300611, -0.64081, -0.707107, -0.871899, -0.92388, -0.955889,
               -0.948776, -0.980785, -1.0, -0.980785, -0.955889, -0.88345, -0.621867, -0.55557, -0.458321,
               -0.182897, -0.19509, -0.370959, -0.544765, -0.83147, -0.92388, -0.980785, -0.981986, -0.980785,
               -0.92388, -0.83147, -0.823697,
        'y': [-0.980785, -0.707107, -0.55557, -0.382683, -0.382683, -0.19509, -0.19509, 0.0, 0.19509, 0.707107,
               0.83147, -0.990393, -0.
